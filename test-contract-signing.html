<!DOCTYPE html>
<html>
<head>
    <title>Test Contract Signing - Visual Proof</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-box { background: #f0f8ff; border: 2px solid #2563eb; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .success-box { background: #d1fae5; border: 2px solid #10b981; color: #065f46; }
        .error-box { background: #fee2e2; border: 2px solid #dc2626; color: #dc2626; }
        button { background: #2563eb; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        input[type="text"] { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>üß™ Contract Signing Test - Visual Proof</h1>
    
    <div class="test-box">
        <h2>Step 1: Fill out the form and click "Test Sign Contract"</h2>
        <p>This will test the exact same AJAX call your React component makes.</p>
        
        <label>Client Name:</label>
        <input type="text" id="clientName" value="Test Client" />
        
        <label>Phone:</label>
        <input type="text" id="clientPhone" value="+44 1234 567890" />
        
        <label>Address:</label>
        <input type="text" id="clientAddress" value="123 Test Street" />
        
        <br><br>
        
        <button id="testSignBtn" onclick="testContractSigning()">Test Sign Contract</button>
        <button onclick="testNewContract()" style="background: #059669; margin-left: 10px;">Create Test Contract First</button>
    </div>
    
    <div id="loadingBox" class="test-box hidden">
        <h3>‚è≥ Testing contract signing...</h3>
        <p>Making the same AJAX call your React component uses...</p>
    </div>
    
    <div id="successBox" class="test-box success-box hidden">
        <h3>‚úÖ SUCCESS: Contract signing works perfectly!</h3>
        <p id="successDetails"></p>
        <p><strong>This proves the green success box should appear in your React app.</strong></p>
    </div>
    
    <div id="errorBox" class="test-box error-box hidden">
        <h3>‚ùå ERROR: Contract signing failed</h3>
        <p id="errorDetails"></p>
    </div>
    
    <div class="test-box">
        <h3>Expected Behavior:</h3>
        <ol>
            <li>Click "Create Test Contract First" to create a contract</li>
            <li>Fill out the form above</li> 
            <li>Click "Test Sign Contract"</li>
            <li>You should see a GREEN SUCCESS BOX appear (not a redirect to JSON)</li>
            <li>Check your email for confirmation messages</li>
        </ol>
    </div>

    <script>
        let testContractId = null;
        
        async function testNewContract() {
            try {
                const response = await fetch('/api/contracts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contractNumber: `TEST-${Date.now()}`,
                        clientName: 'Test Client',
                        clientEmail: 'test@example.com',
                        venue: 'Test Venue',
                        eventDate: new Date().toISOString().split('T')[0],
                        eventTime: '19:00',
                        fee: '500',
                        status: 'sent'
                    })
                });
                
                if (response.ok) {
                    const contract = await response.json();
                    testContractId = contract.id;
                    alert(`‚úÖ Test contract created! ID: ${contract.id}`);
                } else {
                    alert('‚ùå Failed to create test contract. Please log in first.');
                }
            } catch (error) {
                alert('‚ùå Error creating test contract: ' + error.message);
            }
        }
        
        async function testContractSigning() {
            if (!testContractId) {
                alert('Please create a test contract first!');
                return;
            }
            
            // Hide all boxes
            document.getElementById('successBox').classList.add('hidden');
            document.getElementById('errorBox').classList.add('hidden');
            document.getElementById('loadingBox').classList.remove('hidden');
            
            const clientName = document.getElementById('clientName').value;
            const clientPhone = document.getElementById('clientPhone').value;
            const clientAddress = document.getElementById('clientAddress').value;
            
            try {
                console.log('üß™ Testing contract signing with ID:', testContractId);
                
                const response = await fetch(`/api/contracts/sign/${testContractId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        signatureName: clientName,
                        clientName: clientName,
                        clientSignature: `Digital signature: ${clientName} - ${new Date().toISOString()}`,
                        clientIP: '0.0.0.0',
                        clientPhone: clientPhone,
                        clientAddress: clientAddress,
                        venueAddress: clientAddress
                    })
                });
                
                document.getElementById('loadingBox').classList.add('hidden');
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üß™ Success response:', result);
                    
                    document.getElementById('successBox').classList.remove('hidden');
                    document.getElementById('successDetails').textContent = 
                        `Contract ${testContractId} signed successfully! Backend returned: ${JSON.stringify(result)}`;
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('üß™ Test error:', error);
                document.getElementById('loadingBox').classList.add('hidden');
                document.getElementById('errorBox').classList.remove('hidden');
                document.getElementById('errorDetails').textContent = error.message;
            }
        }
    </script>
</body>
</html>