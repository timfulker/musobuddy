<!DOCTYPE html>
<html>
<head>
    <title>Emergency Booking Recovery</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .recovery-item { padding: 10px; border: 1px solid #ccc; margin: 5px 0; }
        .restore-btn { background: #4CAF50; color: white; padding: 5px 10px; border: none; cursor: pointer; }
        .restore-all-btn { background: #2196F3; color: white; padding: 10px 20px; border: none; cursor: pointer; margin: 10px 0; }
        .status { padding: 10px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>üö® Emergency Booking Recovery</h1>
    <p>Recovering your 29 deleted bookings...</p>
    
    <button class="restore-all-btn" onclick="restoreAllBookings()">üîÑ Restore All Deleted Bookings</button>
    
    <div id="status"></div>
    <div id="recovery-items"></div>

    <script>
        async function checkUndoItems() {
            try {
                const response = await fetch('/api/cleanup/undo-items', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.undoItems && data.undoItems.length > 0) {
                    displayUndoItems(data.undoItems);
                } else {
                    document.getElementById('status').innerHTML = '<div class="error">No items found for recovery. They may have been permanently deleted.</div>';
                }
            } catch (error) {
                document.getElementById('status').innerHTML = '<div class="error">Error checking recovery items: ' + error.message + '</div>';
            }
        }

        function displayUndoItems(items) {
            const container = document.getElementById('recovery-items');
            container.innerHTML = '<h3>Recoverable Items (' + items.length + '):</h3>';
            
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'recovery-item';
                div.innerHTML = `
                    <strong>ID:</strong> ${item.id} | 
                    <strong>Table:</strong> ${item.table} | 
                    <strong>Deleted:</strong> ${new Date(item.deletedAt).toLocaleString()}
                    <button class="restore-btn" onclick="restoreItem('${item.table}', ${item.id})">Restore</button>
                `;
                container.appendChild(div);
            });
        }

        async function restoreItem(table, id) {
            try {
                const response = await fetch(`/api/cleanup/undo/${table}/${id}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('status').innerHTML = '<div class="success">‚úÖ Restored ' + table + ' ID: ' + id + '</div>';
                    checkUndoItems(); // Refresh the list
                } else {
                    document.getElementById('status').innerHTML = '<div class="error">‚ùå Failed to restore: ' + data.error + '</div>';
                }
            } catch (error) {
                document.getElementById('status').innerHTML = '<div class="error">‚ùå Error restoring item: ' + error.message + '</div>';
            }
        }

        async function restoreAllBookings() {
            document.getElementById('status').innerHTML = '<div>üîÑ Checking for recoverable bookings...</div>';
            
            try {
                const response = await fetch('/api/cleanup/undo-items', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.undoItems && data.undoItems.length > 0) {
                    const bookingItems = data.undoItems.filter(item => item.table === 'bookings');
                    
                    if (bookingItems.length === 0) {
                        document.getElementById('status').innerHTML = '<div class="error">No deleted bookings found for recovery.</div>';
                        return;
                    }
                    
                    document.getElementById('status').innerHTML = '<div>üîÑ Restoring ' + bookingItems.length + ' bookings...</div>';
                    
                    let restored = 0;
                    let failed = 0;
                    
                    for (const item of bookingItems) {
                        try {
                            const restoreResponse = await fetch(`/api/cleanup/undo/${item.table}/${item.id}`, {
                                method: 'POST',
                                credentials: 'include'
                            });
                            
                            if (restoreResponse.ok) {
                                restored++;
                            } else {
                                failed++;
                            }
                        } catch (error) {
                            failed++;
                        }
                    }
                    
                    document.getElementById('status').innerHTML = `
                        <div class="success">‚úÖ Recovery Complete: ${restored} bookings restored, ${failed} failed</div>
                        <p><strong>Next Steps:</strong> Go back to MusoBuddy and refresh your bookings page to see the restored data.</p>
                    `;
                    
                    // Refresh the recovery list
                    setTimeout(checkUndoItems, 1000);
                    
                } else {
                    document.getElementById('status').innerHTML = '<div class="error">No items found for recovery.</div>';
                }
            } catch (error) {
                document.getElementById('status').innerHTML = '<div class="error">Error during recovery: ' + error.message + '</div>';
            }
        }

        // Check for recoverable items on page load
        checkUndoItems();
    </script>
</body>
</html>