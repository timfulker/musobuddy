<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Event Portal - MusoBuddy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active {
            background: white;
            color: #4338ca;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50">
    <!-- Header -->
    <div class="bg-white/80 backdrop-blur-sm border-b border-indigo-100 shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="p-3 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl shadow-lg">
                        <i data-lucide="music" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold bg-gradient-to-r from-indigo-900 to-purple-900 bg-clip-text text-transparent">
                            Your Event Portal
                        </h1>
                        <p class="text-slate-600 mt-1 flex items-center">
                            <i data-lucide="sparkles" class="w-4 h-4 mr-1 text-indigo-500"></i>
                            <span id="contract-info">Loading...</span>
                        </p>
                    </div>
                </div>
                <div class="bg-green-50 text-green-700 border border-green-200 px-3 py-1 font-medium rounded-md">
                    âœ“ Contract Signed
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- Event Overview -->
        <div class="mb-8 bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-lg">
            <div class="p-6 pb-4">
                <div class="flex items-center text-indigo-900 mb-4">
                    <div class="p-2 bg-indigo-100 rounded-lg mr-3">
                        <i data-lucide="calendar" class="w-5 h-5 text-indigo-600"></i>
                    </div>
                    <h2 class="text-xl font-semibold">Event Overview</h2>
                </div>
            </div>
            <div class="px-6 pb-6">
                <div id="event-overview" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Event details will be populated here -->
                </div>
            </div>
        </div>

        <!-- Collaborative Portal -->
        <div class="shadow-lg border-indigo-100 rounded-lg overflow-hidden">
            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-6">
                <div class="text-xl font-semibold flex items-center">
                    <i data-lucide="heart" class="w-6 h-6 mr-2"></i>
                    Collaborative Event Planning
                </div>
                <p class="text-indigo-100 opacity-90 mt-2">
                    Help us make your event perfect by sharing your preferences and requirements
                </p>
            </div>
            <div class="p-6">
                <!-- Tabs -->
                <div class="flex flex-wrap bg-indigo-50 p-1 rounded-lg mb-6">
                    <button class="tab-button flex-1 flex items-center justify-center text-sm py-2 px-3 rounded transition-all duration-200" data-tab="event-info">
                        <i data-lucide="settings" class="w-4 h-4 mr-1"></i>
                        Event Info
                    </button>
                    <button class="tab-button flex-1 flex items-center justify-center text-sm py-2 px-3 rounded transition-all duration-200" data-tab="music-requests">
                        <i data-lucide="volume-2" class="w-4 h-4 mr-1"></i>
                        Music
                    </button>
                    <button class="tab-button flex-1 flex items-center justify-center text-sm py-2 px-3 rounded transition-all duration-200" data-tab="special-moments">
                        <i data-lucide="heart" class="w-4 h-4 mr-1"></i>
                        Special
                    </button>
                    <button class="tab-button flex-1 flex items-center justify-center text-sm py-2 px-3 rounded transition-all duration-200" data-tab="logistics">
                        <i data-lucide="map-pin" class="w-4 h-4 mr-1"></i>
                        Logistics
                    </button>
                    <button class="tab-button flex-1 flex items-center justify-center text-sm py-2 px-3 rounded transition-all duration-200" data-tab="extras">
                        <i data-lucide="sparkles" class="w-4 h-4 mr-1"></i>
                        Extras
                    </button>
                </div>

                <!-- Event Info Tab -->
                <div id="event-info" class="tab-content space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-slate-700 font-medium flex items-center">
                                <i data-lucide="users" class="w-4 h-4 mr-2 text-indigo-500"></i>
                                Venue Contact Details
                            </label>
                            <input type="text" id="venue-contact" placeholder="On-the-day contact number" class="w-full border border-indigo-200 focus:border-indigo-400 focus:ring-indigo-200 rounded-md px-3 py-2">
                        </div>
                        <div class="space-y-2">
                            <label class="text-slate-700 font-medium flex items-center">
                                <i data-lucide="volume-2" class="w-4 h-4 mr-2 text-indigo-500"></i>
                                Sound Tech Contact
                            </label>
                            <input type="text" id="sound-tech-contact" placeholder="Sound engineer contact" class="w-full border border-indigo-200 focus:border-indigo-400 focus:ring-indigo-200 rounded-md px-3 py-2">
                        </div>
                        <div class="space-y-2">
                            <label class="text-slate-700 font-medium flex items-center">
                                <i data-lucide="settings" class="w-4 h-4 mr-2 text-indigo-500"></i>
                                Stage/Performance Area Size
                            </label>
                            <select id="stage-size" class="w-full border border-indigo-200 focus:border-indigo-400 focus:ring-indigo-200 rounded-md px-3 py-2">
                                <option value="">Select stage size</option>
                                <option value="small">Small (up to 3x3m)</option>
                                <option value="medium">Medium (3x3m to 5x5m)</option>
                                <option value="large">Large (5x5m+)</option>
                                <option value="no-stage">No designated stage</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-slate-700 font-medium flex items-center">
                                <i data-lucide="sparkles" class="w-4 h-4 mr-2 text-indigo-500"></i>
                                Dress Code Preferences
                            </label>
                            <input type="text" id="dress-code" placeholder="e.g., formal, casual, black tie, themed" class="w-full border border-indigo-200 focus:border-indigo-400 focus:ring-indigo-200 rounded-md px-3 py-2">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-slate-700 font-medium flex items-center">
                            <i data-lucide="settings" class="w-4 h-4 mr-2 text-indigo-500"></i>
                            Power & Equipment Availability
                        </label>
                        <textarea id="power-equipment" placeholder="Number of sockets, voltage, any noise limiter restrictions..." class="w-full border border-indigo-200 focus:border-indigo-400 focus:ring-indigo-200 rounded-md px-3 py-2 min-h-[100px]"></textarea>
                    </div>
                </div>

                <!-- Music Requests Tab -->
                <div id="music-requests" class="tab-content space-y-6">
                    <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                        <h3 class="text-lg font-semibold text-purple-800 mb-3 flex items-center">
                            <i data-lucide="volume-2" class="w-5 h-5 mr-2"></i>
                            Music Atmosphere
                        </h3>
                        <div class="space-y-4">
                            <div class="space-y-2">
                                <label class="text-slate-700 font-medium flex items-center">
                                    <i data-lucide="music" class="w-4 h-4 mr-2 text-purple-500"></i>
                                    Style/Mood Preference
                                </label>
                                <select id="style-mood" class="w-full border border-purple-200 focus:border-purple-400 focus:ring-purple-200 rounded-md px-3 py-2">
                                    <option value="">Select music style</option>
                                    <option value="upbeat">ðŸŽ‰ Upbeat & Energetic</option>
                                    <option value="jazzy">ðŸŽ· Jazz & Swing</option>
                                    <option value="romantic">ðŸ’• Romantic & Intimate</option>
                                    <option value="background">ðŸŽµ Background/Ambient</option>
                                    <option value="mixed">ðŸŽ­ Mixed Styles</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="text-slate-700 font-medium flex items-center">
                                    <i data-lucide="clock" class="w-4 h-4 mr-2 text-purple-500"></i>
                                    Set Order Preferences
                                </label>
                                <select id="set-order" class="w-full border border-purple-200 focus:border-purple-400 focus:ring-purple-200 rounded-md px-3 py-2">
                                    <option value="">Preferred energy flow</option>
                                    <option value="upbeat-first">âš¡ Start upbeat, slow later</option>
                                    <option value="slow-first">ðŸŒ… Start slow, build energy</option>
                                    <option value="mixed">ðŸŽª Mixed throughout</option>
                                    <option value="no-preference">ðŸ¤· No preference</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                        <h3 class="text-lg font-semibold text-green-800 mb-3 flex items-center">
                            <i data-lucide="heart" class="w-5 h-5 mr-2"></i>
                            Song Requests
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="text-slate-700 font-medium flex items-center">
                                    <i data-lucide="music" class="w-4 h-4 mr-2 text-green-500"></i>
                                    Must-Play Songs (up to 6)
                                </label>
                                <textarea id="must-play-songs" placeholder="List your favourite songs you'd love to hear (artist - song title)" class="w-full border border-green-200 focus:border-green-400 focus:ring-green-200 rounded-md px-3 py-2 min-h-[120px]"></textarea>
                            </div>
                            <div class="space-y-2">
                                <label class="text-slate-700 font-medium flex items-center">
                                    <i data-lucide="x" class="w-4 h-4 mr-2 text-red-500"></i>
                                    Songs to Avoid
                                </label>
                                <textarea id="avoid-songs" placeholder="Any songs or genres you'd prefer we don't play" class="w-full border border-green-200 focus:border-green-400 focus:ring-green-200 rounded-md px-3 py-2 min-h-[120px]"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Section -->
                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-4 border border-indigo-200 mt-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="p-2 bg-indigo-100 rounded-lg">
                                <i data-lucide="clock" class="w-4 h-4 text-indigo-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-slate-700">Last Updated</p>
                                <p id="last-updated" class="text-xs text-slate-500">Never</p>
                            </div>
                        </div>
                        <button id="save-btn" onclick="savePortalData()" class="flex items-center bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 shadow-md text-white px-4 py-2 rounded-md transition-all duration-200">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                            <span>Save Changes</span>
                        </button>
                    </div>
                </div>

                <!-- Status Messages -->
                <div id="status-message" class="mt-4 hidden"></div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-12 text-center">
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-lg p-6 text-white">
                <div class="flex items-center justify-center mb-3">
                    <i data-lucide="music" class="w-6 h-6 mr-2"></i>
                    <h3 class="text-lg font-semibold">Collaborative Event Planning</h3>
                </div>
                <p class="text-indigo-100 mb-2">This portal allows you to collaborate on your event details.</p>
                <p class="text-indigo-100">Your performer will be notified of any updates you make.</p>
                <div class="mt-4 pt-4 border-t border-indigo-400">
                    <p class="text-xs text-indigo-200">
                        Powered by MusoBuddy â€¢ Professional Music Business Management
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const contractId = window.location.pathname.split('/').pop();
        const token = urlParams.get('token');
        const apiBase = 'https://f19aba74-886b-4308-a2de-cc9ba5e94af8-00-2ux7uy3ch9t9f.janeway.replit.dev';

        let portalData = {};
        let hasChanges = false;

        // Tab functionality
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Set first tab as active
            tabButtons[0].classList.add('active');
            tabContents[0].classList.add('active');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    button.classList.add('active');
                    document.getElementById(targetTab).classList.add('active');
                });
            });

            // Load portal data
            loadPortalData();

            // Track changes
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('change', () => {
                    hasChanges = true;
                    updateSaveButton();
                });
            });
        });

        function updateSaveButton() {
            const saveBtn = document.getElementById('save-btn');
            if (hasChanges) {
                saveBtn.querySelector('span').textContent = 'Save Changes';
                saveBtn.disabled = false;
            } else {
                saveBtn.querySelector('span').textContent = 'No Changes';
                saveBtn.disabled = true;
            }
        }

        async function loadPortalData() {
            try {
                const response = await fetch(`${apiBase}/api/client-portal/${contractId}?token=${token}`);
                if (!response.ok) {
                    throw new Error('Failed to load portal data');
                }
                
                const data = await response.json();
                portalData = data;
                
                // Update contract info
                document.getElementById('contract-info').textContent = 
                    `Contract #${data.contract.contractNumber} â€¢ ${data.contract.clientName}`;
                
                // Update event overview
                updateEventOverview(data.contract);
                
                // Populate form fields
                if (data.clientData) {
                    populateFormFields(data.clientData);
                    document.getElementById('last-updated').textContent = 
                        data.clientData.updatedAt ? new Date(data.clientData.updatedAt).toLocaleDateString('en-GB') : 'Never';
                }
                
            } catch (error) {
                console.error('Error loading portal data:', error);
                showStatusMessage('Failed to load event data. Please check your link.', 'error');
            }
        }

        function updateEventOverview(contract) {
            const overview = document.getElementById('event-overview');
            overview.innerHTML = `
                <div class="bg-white rounded-lg p-4 shadow-sm border border-indigo-100">
                    <div class="text-sm font-medium text-indigo-600 flex items-center mb-2">
                        <i data-lucide="calendar" class="w-4 h-4 mr-1"></i>
                        Date
                    </div>
                    <p class="text-xl font-bold text-slate-900">${new Date(contract.eventDate).toLocaleDateString('en-GB')}</p>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm border border-indigo-100">
                    <div class="text-sm font-medium text-indigo-600 flex items-center mb-2">
                        <i data-lucide="clock" class="w-4 h-4 mr-1"></i>
                        Time
                    </div>
                    <p class="text-xl font-bold text-slate-900">
                        ${contract.eventTime || 'TBC'} ${contract.eventEndTime ? `- ${contract.eventEndTime}` : ''}
                    </p>
                    ${contract.performanceDuration ? `
                        <p class="text-sm text-purple-600 mt-1 flex items-center">
                            <i data-lucide="mic-2" class="w-3 h-3 mr-1"></i>
                            Performance: ${contract.performanceDuration}
                        </p>
                    ` : ''}
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm border border-indigo-100">
                    <div class="text-sm font-medium text-indigo-600 flex items-center mb-2">
                        <i data-lucide="map-pin" class="w-4 h-4 mr-1"></i>
                        Venue
                    </div>
                    <p class="text-xl font-bold text-slate-900">${contract.venue || 'TBC'}</p>
                </div>
            `;
            lucide.createIcons();
        }

        function populateFormFields(clientData) {
            const fields = [
                'venue-contact', 'sound-tech-contact', 'stage-size', 'dress-code',
                'power-equipment', 'style-mood', 'set-order', 'must-play-songs', 'avoid-songs'
            ];
            
            fields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                const dataKey = fieldId.replace(/-/g, '');
                if (element && clientData[dataKey]) {
                    element.value = clientData[dataKey];
                }
            });
        }

        async function savePortalData() {
            if (!hasChanges) return;
            
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.querySelector('span').textContent = 'Saving...';
            
            try {
                const formData = {
                    token: token,
                    venueContact: document.getElementById('venue-contact').value,
                    soundTechContact: document.getElementById('sound-tech-contact').value,
                    stageSize: document.getElementById('stage-size').value,
                    dressCode: document.getElementById('dress-code').value,
                    powerEquipment: document.getElementById('power-equipment').value,
                    styleMood: document.getElementById('style-mood').value,
                    setOrder: document.getElementById('set-order').value,
                    mustPlaySongs: document.getElementById('must-play-songs').value,
                    avoidSongs: document.getElementById('avoid-songs').value
                };
                
                const response = await fetch(`${apiBase}/api/client-portal/${contractId}/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save changes');
                }
                
                hasChanges = false;
                updateSaveButton();
                document.getElementById('last-updated').textContent = new Date().toLocaleDateString('en-GB');
                showStatusMessage('Your changes have been saved successfully! Your performer will be notified.', 'success');
                
            } catch (error) {
                console.error('Error saving portal data:', error);
                showStatusMessage('Failed to save changes. Please try again.', 'error');
                saveBtn.disabled = false;
                saveBtn.querySelector('span').textContent = 'Save Changes';
            }
        }

        function showStatusMessage(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `mt-4 p-4 rounded-lg border ${
                type === 'success' 
                    ? 'border-green-200 bg-green-50 text-green-800' 
                    : 'border-red-200 bg-red-50 text-red-800'
            }`;
            statusDiv.innerHTML = `
                <div class="flex items-center">
                    <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-4 h-4 mr-2"></i>
                    ${message}
                </div>
            `;
            statusDiv.classList.remove('hidden');
            lucide.createIcons();
            
            // Hide after 5 seconds
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>