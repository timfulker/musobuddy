import { useState, useEffect } from 'react';
import { User } from 'firebase/auth';
import { onAuthStateChange, signInWithGoogle, signOutUser, getGoogleRedirectResult } from '@shared/firebase';
import { useQueryClient } from '@tanstack/react-query';

export function useFirebaseAuth() {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const queryClient = useQueryClient();

  useEffect(() => {
    // Check for redirect result first (in case we're coming back from a redirect)
    getGoogleRedirectResult()
      .then((result) => {
        if (result?.user) {
          console.log('üî• Got redirect result with user:', result.user.email);
        }
      })
      .catch((error) => {
        console.log('üî• No redirect result or error:', error.code);
      });

    const unsubscribe = onAuthStateChange(async (firebaseUser) => {
      console.log('üî• Firebase auth state changed:', !!firebaseUser);
      setUser(firebaseUser);
      setLoading(false);

      if (firebaseUser) {
        try {
          console.log('üî• Firebase user detected:', {
            uid: firebaseUser.uid,
            email: firebaseUser.email,
            displayName: firebaseUser.displayName
          });

          // Get Firebase ID token
          const idToken = await firebaseUser.getIdToken(true); // Force refresh
          console.log('üé´ Got Firebase ID token, length:', idToken.length);
          console.log('üé´ Token preview:', idToken.substring(0, 50) + '...');

          // Verify user exists in our database and check subscription
          console.log('üîÑ Verifying user in database...');
          const apiUrl = import.meta.env.DEV ? '/api/auth/firebase-login' : '/api/auth/firebase-login';
          console.log('üì° Making request to:', apiUrl);
          
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              idToken: idToken
            })
          });

          console.log('üåê User verification response:', {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok
          });

          if (!response.ok) {
            const errorText = await response.text();
            let errorData;
            try {
              errorData = JSON.parse(errorText);
            } catch {
              errorData = { error: errorText };
            }
            console.log('‚ùå User verification failed:', {
              status: response.status,
              statusText: response.statusText,
              url: response.url,
              data: errorData
            });
            throw new Error(`User verification failed: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          console.log('üì¶ Firebase login response data:', data);
          console.log('üì¶ DETAILED RESPONSE ANALYSIS:');
          console.log('  - data.paymentRequired:', data.paymentRequired);
          console.log('  - data.user?.tier:', data.user?.tier);
          console.log('  - data.user?.isAdmin:', data.user?.isAdmin);
          console.log('  - Payment redirect condition 1:', (data.paymentRequired && !data.user?.isAdmin));
          console.log('  - Payment redirect condition 2:', (data.user?.tier === 'pending_payment' && !data.user?.isAdmin));
          console.log('  - WILL REDIRECT:', ((data.paymentRequired && !data.user?.isAdmin) || (data.user?.tier === 'pending_payment' && !data.user?.isAdmin)));
          
          // Check if payment is required
          // Check if user needs payment (either paymentRequired flag OR tier is pending_payment)
          if ((data.paymentRequired && !data.user?.isAdmin) || 
              (data.user?.tier === 'pending_payment' && !data.user?.isAdmin)) {
            console.log('üí≥ Payment required for user:', {
              email: data.user?.email,
              userId: data.user?.userId,
              tier: data.user?.tier,
              paymentRequired: data.paymentRequired
            });
            
            // Redirect to Stripe checkout for payment IMMEDIATELY
            try {
              const stripeResponse = await fetch('/api/stripe/create-checkout', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  userId: data.user?.userId,
                  email: data.user?.email
                }),
              });

              if (stripeResponse.ok) {
                const stripeData = await stripeResponse.json();
                console.log('‚úÖ Stripe checkout created - redirecting immediately:', stripeData);
                if (stripeData.url || stripeData.checkoutUrl) {
                  window.location.href = stripeData.url || stripeData.checkoutUrl;
                  return;
                } else {
                  console.error('‚ùå No checkout URL in response:', stripeData);
                }
              } else {
                const errorData = await stripeResponse.json();
                console.error('‚ùå Stripe checkout failed:', stripeResponse.status, errorData);
              }
            } catch (stripeError) {
              console.error('‚ùå Failed to create Stripe checkout:', stripeError);
            }
            
            // Fallback: redirect to pricing page instead of signup
            console.log('‚ö†Ô∏è Redirecting to pricing page as fallback');
            window.location.href = '/pricing';
            return;
          }
          
          console.log('‚úÖ Firebase login successful, user verified');
          
          // Invalidate auth queries to refresh user data
          queryClient.invalidateQueries({ queryKey: ['/api/auth/user'] });
          
          // Redirect to dashboard if on auth pages
          if (window.location.pathname.startsWith('/auth') || 
              window.location.pathname === '/login' || 
              window.location.pathname === '/signup') {
            setTimeout(() => {
              window.location.href = '/dashboard';
            }, 500);
          }
        } catch (err) {
          console.error('‚ùå Firebase token exchange failed:', err);
          setError(err instanceof Error ? err.message : 'Authentication failed');
        }
      } else {
        // User signed out - clear all data
        queryClient.clear();
      }
    });

    return () => unsubscribe();
  }, [queryClient]);

  const loginWithGoogle = async () => {
    try {
      setError(null);
      console.log('üî• Initiating Google login with popup...');
      const result = await signInWithGoogle();
      console.log('üî• Google login successful:', result.user?.email);
      // The auth state change listener will handle the rest
    } catch (err) {
      console.error('‚ùå Google login failed:', err);
      setError(err instanceof Error ? err.message : 'Login failed');
    }
  };

  const logout = async () => {
    try {
      await signOutUser();
      localStorage.removeItem('musobuddy-theme');
      localStorage.removeItem('musobuddy-custom-color');
      queryClient.clear();
      window.location.href = '/';
    } catch (err) {
      console.error('‚ùå Logout failed:', err);
      // Force cleanup even if logout fails
      localStorage.removeItem('musobuddy-theme');
      localStorage.removeItem('musobuddy-custom-color');
      queryClient.clear();
      window.location.href = '/';
    }
  };

  return {
    user,
    loading,
    error,
    loginWithGoogle,
    logout,
    isAuthenticated: !!user
  };
}